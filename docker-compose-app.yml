# ============================================
# DOCKER COMPOSE - APPLICATION
# ============================================
# Ce fichier gère les services applicatifs :
# - Nginx, Backend, Frontend, Redis, Elasticsearch
# Le backend est connecté à db-network pour accéder à MongoDB
# ============================================

services:
  # ==========================================
  # NGINX - Reverse Proxy
  # ==========================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx
    ports:
      - "80:80"
    networks:
      - app-network
    depends_on:
      - backend
      - frontend
    deploy:
      resources:
        limits:
          memory: 64M
    restart: unless-stopped

  # ==========================================
  # BACKEND - API Node.js/Express
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    environment:
      # MongoDB - connexion au replica set via db-network
      MONGODB_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-admin_password}@mongodb-primary:27017/bibliotheque?authSource=admin&replicaSet=rs0
      # Redis (même réseau app-network)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Elasticsearch (même réseau app-network)
      ELASTICSEARCH_URL: http://elasticsearch:9200
      # JWT
      JWT_SECRET: ${JWT_SECRET:-super_secret_jwt_key}
      SALT_ROUNDS: 10
      # Port
      PORT: 5000
    ports:
      - "5000:5000"
    networks:
      - app-network
      - db-network    # Connecté aux 2 réseaux pour accéder à MongoDB
    depends_on:
      - redis
      - elasticsearch
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped

  # ==========================================
  # FRONTEND - React/Vite
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: dockerfile
    container_name: frontend
    environment:
      VITE_API_URL: http://localhost/api
    ports:
      - "3000:3000"
    networks:
      - app-network
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped

  # ==========================================
  # REDIS - Cache en mémoire
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M
    restart: unless-stopped

  # ==========================================
  # ELASTICSEARCH - Stockage des logs
  # ==========================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped

# ==========================================
# VOLUMES - Persistance Redis et Elasticsearch
# ==========================================
volumes:
  redis_data:
    name: redis_data
  elasticsearch_data:
    name: elasticsearch_data

# ==========================================
# RÉSEAUX
# ==========================================
networks:
  app-network:
    name: app-network
    driver: bridge
  db-network:
    external: true
    name: db-network
